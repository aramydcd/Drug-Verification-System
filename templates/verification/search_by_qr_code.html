{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">üîç Verify Drug by QR Code</h4>
        </div>
        <div class="card-body">
            <!-- Search Form -->
            <form method="POST" enctype="multipart/form-data" class="card p-4 shadow-lg border-0 rounded-3 bg-light mt-3">
                {% csrf_token %}
                
                <!-- Manual Input -->
                <label class="form-label">Enter QR Code</label>
                <div class="input-group mb-3">
                    <input type="text" id="qr_code_input" name="qr_code" class="form-control" placeholder="Enter QR Code">
                    <button type="submit" class="btn btn-primary">Search</button>
                </div>

                <div class="text-center my-3 fw-bold">OR</div>

                <div class="row g-3">
                    <!-- Camera Scanner -->
                    <div class="col-md-6 text-center">
                        <label class="form-label fw-bold">Scan QR Code</label>
                        <button type="button" class="btn btn-outline-success w-75" id="start-scan">üì∑ Start Camera Scan</button>
                        <button type="button" class="btn btn-outline-danger w-75 mt-2" id="stop-scan" style="display:none;">‚úñ Stop Camera</button>
                        
                        <!-- Spinner -->
                        <div id="scan-spinner" class="mt-3 text-primary fw-bold" style="display:none;">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">Scanning... Please hold steady</p>
                        </div>

                        <!-- Camera view -->
                        <div id="reader" class="mt-3 border rounded mx-auto" style="width:350px; height:250px; display:none;"></div>
                    </div>

                    <!-- Upload QR Image -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Upload QR Image</label>
                        <input type="file" id="qr-file" accept="image/*" class="form-control">
                        <img id="preview" class="img-thumbnail mt-2 shadow-sm" style="max-height:150px; display:none;">
                    </div>
                    <!-- Add a hidden div for Html5Qrcode -->
                    <div id="qr-reader" style="display:none;"></div>
                </div>
            </form>

            <!-- Result Display -->
            {% if result %}
                {% if result == "Authentic ‚úÖ" %}
                    <div class="alert mt-4 alert-success fw-bold">
                        {{ result }}
                    </div>

                    {% if drug %}
                        <div class="card mt-3 shadow">
                            <div class="card-body row">
                                <div class="col-md-4 text-center">
                                    {% if drug.image %}
                                        <img src="{{ drug.image.url }}" class="img-fluid rounded shadow-sm" style="max-height:200px;">
                                    {% else %}
                                        <span class="text-muted">No Image</span>
                                    {% endif %}
                                </div>
                                <div class="col-md-8">
                                    <h5 class="card-title text-primary">{{ drug.name }}</h5>
                                    <p><strong>Manufacturer:</strong> {{ drug.company.username }}</p>
                                    <p><strong>Batch No:</strong> {{ drug.batch_number }}</p>
                                    <p><strong>Expiry Date:</strong> {{ drug.expiry_date }}</p>
                                    <p><strong>Manufacturing Date:</strong> {{ drug.manufacturer_date }}</p>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="card mt-4 border-danger shadow">
                        <div class="card-body text-center">
                            <h5 class="text-danger">‚ùå Fake Drug Detected</h5>
                            <p class="text-muted">This QR code is not registered in the system. Please avoid using this product.</p>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 9999">
    <div id="scan-toast" class="toast align-items-center text-bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body fw-bold">
                ‚úÖ QR Code detected! Submitting...
            </div>
        </div>
    </div>
</div>

<!-- QR Scanner Script -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
    let html5QrCode;

    // Bootstrap toast setup
    function showToast() {
        const toastEl = document.getElementById("scan-toast");
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }

    // Start Camera Scan
    document.getElementById("start-scan").addEventListener("click", function() {
        document.getElementById("reader").style.display = "block";
        document.getElementById("stop-scan").style.display = "inline-block";
        document.getElementById("scan-spinner").style.display = "block";
        this.style.display = "none";

        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 200 } },
            (decodedText) => {
                decodedText = decodedText.trim();
                document.getElementById("qr_code_input").value = decodedText;
                showToast();

                // Stop camera after successful scan
                html5QrCode.stop().then(() => {
                    document.getElementById("reader").style.display = "none";
                    document.getElementById("scan-spinner").style.display = "none";
                    document.getElementById("start-scan").style.display = "inline-block";
                    document.getElementById("stop-scan").style.display = "none";

                    // Auto-submit form
                    setTimeout(() => document.querySelector("form").submit(), 1200);
                });
            }
        ).catch(err => {
            console.error("Camera start error:", err);
            document.getElementById("scan-spinner").style.display = "none";
        });
    });

    // Stop Camera Scan
    document.getElementById("stop-scan").addEventListener("click", function() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                document.getElementById("reader").style.display = "none";
                document.getElementById("scan-spinner").style.display = "none";
                document.getElementById("start-scan").style.display = "inline-block";
                this.style.display = "none";
            }).catch(err => console.error("Camera stop error:", err));
        }
    });

    // Upload & Scan QR Code Image
    document.getElementById("qr-file").addEventListener("change", function(event) {
    let file = event.target.files[0];
    if (!file) return;

    // Show preview
    let preview = document.getElementById("preview");
    preview.src = URL.createObjectURL(file);
    preview.style.display = "block";

    // Create scanner instance
    const html5QrCode = new Html5Qrcode("qr-reader");

    // Try scanning the uploaded file
    html5QrCode.scanFileV2(file, true)
        .then(decodedResult => {
            // Print raw result
            console.log("Decoded result object:", decodedResult);

            // Handle text (depending on return type)
            decodedText = (typeof decodedResult === "string")
                ? decodedResult
                : decodedResult.decodedText;
            // const decodedText = decodedResult

            console.log("‚úÖ Extracted QR Text:", decodedText);
            decodedText = decodedText.trim();
            document.getElementById("qr_code_input").value = decodedText;
            showToast();
            // ‚úÖ Auto-submit form after short delay
            setTimeout(() => {
                document.querySelector("form").submit();
            }, 1200);
        })
        .catch(err => {
            console.error("‚ùå No QR code found:", err);
        });
    });



</script>
{% endblock %}

